{"ast":null,"code":"var __jsx = React.createElement;\n\nfunction ownKeys(object, enumerableOnly) { var keys = Object.keys(object); if (Object.getOwnPropertySymbols) { var symbols = Object.getOwnPropertySymbols(object); if (enumerableOnly) { symbols = symbols.filter(function (sym) { return Object.getOwnPropertyDescriptor(object, sym).enumerable; }); } keys.push.apply(keys, symbols); } return keys; }\n\nfunction _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i] != null ? arguments[i] : {}; if (i % 2) { ownKeys(Object(source), true).forEach(function (key) { _defineProperty(target, key, source[key]); }); } else if (Object.getOwnPropertyDescriptors) { Object.defineProperties(target, Object.getOwnPropertyDescriptors(source)); } else { ownKeys(Object(source)).forEach(function (key) { Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key)); }); } } return target; }\n\nfunction _defineProperty(obj, key, value) { if (key in obj) { Object.defineProperty(obj, key, { value: value, enumerable: true, configurable: true, writable: true }); } else { obj[key] = value; } return obj; }\n\nimport dynamic from \"next/dynamic\";\nimport React from \"react\";\nimport { promises as fs } from \"fs\";\nimport path from \"path\";\nexport default function Home(props) {\n  const MapComponent = dynamic(() => import(\"../components/mapComponent\"), {\n    ssr: false,\n    loadableGenerated: {\n      webpack: () => [require.resolveWeak(\"../components/mapComponent\")],\n      modules: [\"../components/mapComponent\"]\n    }\n  });\n  return __jsx(\"div\", {\n    className: \"main\"\n  }, __jsx(MapComponent, {\n    lon: 6,\n    lat: 24.5,\n    countries: props.data.countries,\n    pathfinderExploratory: props.data.pathfinders.exploratory,\n    pathfinderConfirmed: props.data.pathfinders.confirmed,\n    digitalGoods: props.data.digitalGoods,\n    story: props.data.story,\n    devPolygons: props.data.polygons[1],\n    depPolygons: props.data.polygons[0]\n  }));\n}\nexport async function getStaticProps() {\n  const renameCountry = {\n    \"Cote d'Ivoire\": \"Ivory Coast\",\n    DRC: \"Congo, the Democratic Republic of the\",\n    Eswatini: \"eSwatini (former Swaziland)\",\n    Tanzania: \"United Republic of Tanzania\",\n    \"United States of America\": \"United States\",\n    \"Antigua And Barbuda\": \"Antigua and Barbuda\",\n    \"Bolivia (Plurinational State of)\": \"Bolivia\",\n    \"Bosnia And Herzegowina\": \"Bosnia and Herzegovina\",\n    \"Cabo Verde\": \"Cape Verde\",\n    Czechia: \"Czech Republic\",\n    \"Côte d'Ivoire\": \"Ivory Coast\",\n    \"Democratic Republic of the Congo\": \"Congo, the Democratic Republic of the\",\n    \"Iran (Islamic Republic Of)\": \"Iran\",\n    Luxemburg: \"Luxembourg\",\n    \"Micronesia, Federated States Of\": \"Micronesia\",\n    \"Saint Kitts And Nevis\": \"Saint Kitts and Nevis\",\n    \"Saint Vincent And The Grenadines\": \"Saint Vincent and the Grenadines\",\n    // +\n    \"Sao Tome And Principe\": \"Sao Tome and Principe\",\n    // +\n    \"Sint Maarten\": \"Sint Maarten (Dutch part)\",\n    \"Slovakia (Slovak Republic)\": \"Slovakia\",\n    \"South Georgia And South S.S.\": \"South Georgia and the South Sandwich Islands\",\n    \"St. Pierre And Miquelon\": \"Saint Pierre and Miquelon\",\n    \"State of Palestine\": \"Palestine\",\n    \"Syrian Arab Republic\": \"Syria\",\n    \"Trinidad And Tobago\": \"Trinidad and Tobago\",\n    \"Turks And Caicos Islands\": \"Turks and Caicos Islands\",\n    \"United Republic of Tanzania\": \"United Republic of Tanzania\",\n    \"Virgin Islands (British)\": \"Virgin Islands, British\",\n    US: \"United States\",\n    UK: \"United Kingdom\",\n    \"Cote D'Ivoire\": \"Ivory Coast\",\n    USA: \"United States\",\n    Africa: \"Africa\",\n    // ???\n    Bravil: \"Bravil\",\n    // ???\n    Haita: \"Haiti\",\n    // ???\n    Zimbwabwe: \"Zimbabwe\",\n    \"United Kingdom of Great Britain And Northern Ireland\": \"United Kingdom\",\n    Vanuata: \"Vanuatu\",\n    Bosnia: \"Bosnia and Herzegovina\",\n    \"Cote d’Ivoire\": \"Ivory Coast\",\n    Kazahkstan: \"Kazakhstan\",\n    \"North Korea\": \"Korea, Democratic People's Republic of\",\n    \"Republic of Congo\": \"Congo\",\n    \"Palestine State\": \"Palestine\",\n    \"United Kingdom of Great Britain and Northern Ireland\": \"United Kingdom\",\n    \"Korea (the Republic of Korea)\": \"Korea, Democratic People's Republic of\",\n    \"Viet Nam\": \"Vietnam\",\n    Macedonia: \"North Macedonia\",\n    \"Congo (the Democratic Republic of the Congo)\": \"Congo, the Democratic Republic of the\",\n    \"Brunei Darussalam\": \"Brunei\",\n    Curaçao: \"Curaçao\",\n    // The Netherlands Antilles (AN, ANT, 530) was divided into Bonaire, Saint Eustatius and Saba (BQ, BES, 535), Curaçao (CW, CUW, 531) and Sint Maarten (Dutch part) (SX, SXM, 534).\n    \"Virgin Islands (U.S.)\": \"Virgin Islands, U.S.\",\n    \"Bonaire, Sint Eustatius, and Saba\": \"Bonaire, Sint Eustatius, and Saba\",\n    // The Netherlands Antilles (AN, ANT, 530) was divided into Bonaire, Saint Eustatius and Saba (BQ, BES, 535), Curaçao (CW, CUW, 531) and Sint Maarten (Dutch part) (SX, SXM, 534).\n    \"Falkland Islands\": \"Falkland Islands (Malvinas)\",\n    \"The Faroe Islands\": \"Faroe Islands\",\n    Kyrgyztan: \"Kyrgyzstan\",\n    SouthAfrica: \"South Africa\",\n    Swaziland: \"eSwatini (former Swaziland)\",\n    VietNam: \"Vietnam\",\n    Curaçao: \"Curaçao\",\n    \"Lao People's Democratic Republic\": \"Laos\"\n  };\n\n  const convertArrayToObject = (array, key) => array.reduce((acc, curr) => (acc[curr[key]] = curr, acc), {});\n\n  const csv = require(\"csvtojson\");\n\n  const nodefetch = require(\"node-fetch\");\n\n  const csvFilePath = path.join(process.cwd(), \"public/countries_codes_and_coordinates.csv\");\n  const loadAlpha = await csv().fromFile(csvFilePath).then(jsonObj => {\n    return convertArrayToObject(jsonObj, \"Country\");\n  });\n\n  const fetchData = async () => {\n    const alpha3 = _objectSpread({}, loadAlpha);\n\n    var countries = {};\n    var mismatched = {}; //TODO: add an ability to fetch more than 100 dpgs\n\n    const result = await fetch(\"https://api.github.com/search/code?q=repo:unicef/publicgoods-candidates+path:digitalpublicgoods+filename:.json&per_page=100\");\n    const goodsFileNames = await result.json();\n\n    const handleCountries = data => {\n      let deployGoods = {};\n      let developmentGoods = {};\n      let c = countries;\n      [\"deploymentCountries\", \"developmentCountries\"].map(el => {\n        data.locations[el].map(country => {\n          country = renameCountry[country] ? renameCountry[country] : country;\n\n          if (!alpha3[country]) {\n            // console.log(\"Mismatched good \" + country);\n            mismatched[country] = country + \" deploy \" + data.name;\n          } else {\n            if (!Object.keys(c).find(e => e == alpha3[country][\"Alpha-3\"])) {\n              c[alpha3[country][\"Alpha-3\"]] = {};\n            }\n\n            let code = alpha3[country][\"Alpha-3\"];\n            el == \"deploymentCountries\" ? deployGoods[code] = country : developmentGoods[code] = country;\n            c[code][\"name\"] = country;\n            c[code][\"code\"] = code;\n            c[code][\"lat\"] = alpha3[country][\"Latitude (average)\"];\n            c[code][\"lon\"] = alpha3[country][\"Longitude (average)\"];\n          }\n        });\n      });\n      data.locations.deploymentCountries = deployGoods;\n      data.locations.developmentCountries = developmentGoods;\n      countries = c;\n      return data;\n    };\n\n    const digitalGoodsData = await goodsFileNames.items.map(async filename => {\n      const res = await fetch(\"https://raw.githubusercontent.com/unicef/publicgoods-candidates/master/digitalpublicgoods/\" + filename.name);\n      const fileContents = await res.text();\n      const nomineeRes = await fetch(\"https://raw.githubusercontent.com/unicef/publicgoods-candidates/master/nominees/\" + filename.name);\n      const nomineeFileContents = await nomineeRes.text();\n\n      try {\n        let goodsData = JSON.parse(fileContents);\n        let nomineeData = JSON.parse(nomineeFileContents);\n        return _objectSpread(_objectSpread({}, handleCountries(goodsData)), nomineeData);\n      } catch (error) {\n        // handle linked json\n        const res = await fetch(\"https://raw.githubusercontent.com/unicef/publicgoods-candidates/master/digitalpublicgoods/\" + fileContents);\n        const nestedFileContent = await res.text();\n        const nnomineeRes = await fetch(\"https://raw.githubusercontent.com/unicef/publicgoods-candidates/master/nominees/\" + filename.name);\n        const nestedNomineeFileContents = await nnomineeRes.text();\n        let ngoodsData = JSON.parse(nestedFileContent);\n        ngoodsData.name = filename.name.replace(\".json\", \"\");\n        let nnomineeData = JSON.parse(nestedNomineeFileContents);\n        return _objectSpread(_objectSpread({}, handleCountries(ngoodsData)), nnomineeData);\n      }\n    });\n    var digitalGoodsArr = await Promise.all(digitalGoodsData);\n\n    const addStory = results => {\n      // replace all //n //r, FALSE\n      for (let i = 0; i < results.length; i++) {\n        results[i].text = results[i].text.replace(/[\\r\\n]+/gm, \" \");\n        results[i].image = results[i].image.replace(\"FALSE\", false);\n        results[i].image = results[i].image.replace(\"TRUE\", true);\n      }\n\n      return results;\n    };\n\n    const loadGsheet = async (sheetId, sheetGidNumber) => {\n      let sheetResponse = await nodefetch(`https://docs.google.com/spreadsheets/u/1/d/${sheetId}/export?format=csv&id=${sheetId}&gid=${sheetGidNumber}`);\n      let resultText = await sheetResponse.text();\n      return await csv().fromString(resultText);\n    };\n\n    const storyData = addStory(await loadGsheet(process.env.NEXT_PUBLIC_SHEET_ID, 728344896));\n\n    const addCountries = async (results, label) => {\n      let s = {};\n      let l = {};\n      let c = countries;\n      results.map((el, i) => {\n        let country = renameCountry[el.Country] ? renameCountry[el.Country] : el.Country;\n\n        if (!alpha3[country]) {\n          console.log(\"Mismatched \" + country);\n          mismatched[country] = country + \" \" + label;\n        } else {\n          if (!Object.keys(c).find(e => e == alpha3[country][\"Alpha-3\"])) {\n            c[alpha3[country][\"Alpha-3\"]] = {};\n          }\n\n          let code = alpha3[country][\"Alpha-3\"];\n          c[code][label] = el;\n          c[code][\"name\"] = country;\n          c[code][\"code\"] = code;\n          c[code][\"lat\"] = alpha3[country][\"Latitude (average)\"];\n          c[code][\"lon\"] = alpha3[country][\"Longitude (average)\"];\n          el.Status == \"Confirmed\" ? s[code] = el : l[code] = el;\n        }\n      });\n      countries = c;\n      return {\n        confirmed: s,\n        exploratory: l\n      };\n    };\n\n    const pathfinderData = await loadGsheet(process.env.NEXT_PUBLIC_SHEET_ID, 635692465);\n    const pathfinders = await addCountries(pathfinderData, \"pathfinder\");\n    const polygonsDirectory = path.join(process.cwd(), \"public\");\n    const filenames = await fs.readdir(polygonsDirectory);\n    const polygons = filenames.filter(el => [\"polygons-deployments.geojson\", \"polygons-developments.geojson\"].includes(el)).map(async (filename, index) => {\n      const filePath = path.join(polygonsDirectory, filename);\n      const fileContents = await fs.readFile(filePath, \"utf8\");\n      const polygon = JSON.parse(fileContents);\n      let arrayOfCountries = index == 0 ? \"deploymentCountries\" : \"developmentCountries\";\n      polygon[\"features\"].map(el => {\n        el.properties[\"text-field\"] = digitalGoodsArr.filter(good => Object.keys(good.locations[arrayOfCountries]).includes(el.properties.iso)).length.toString();\n        el.properties[\"height\"] = parseFloat(el.properties[\"text-field\"]) * 20000;\n        el.properties[\"base\"] = el.properties[\"height\"] == 0 ? 999999999999 : 0;\n        el.properties[\"height\"] += el.properties[\"height\"] == 0 ? 999999999999 : 0;\n      });\n      return polygon;\n    });\n    console.log(\"missmathes\", mismatched);\n    return {\n      countries: countries,\n      digitalGoods: digitalGoodsArr,\n      pathfinders: pathfinders,\n      polygons: await Promise.all(polygons),\n      story: storyData\n    };\n  };\n\n  return {\n    props: {\n      data: await fetchData()\n    },\n    revalidate: 60\n  };\n}","map":null,"metadata":{},"sourceType":"module"}